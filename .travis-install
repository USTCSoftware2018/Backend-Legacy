#!/bin/bash

wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.6.deb -O es.deb
sudo dpkg -i --force-confnew es.deb
sudo service elasticsearch start

python3.4 biohub/biocircuit/compile-espresso.py

python -c "import os;os.chdir('biohub/biocircuit');from espresso import espresso"

if [ $? -ne 0 ]; then
    exit 1
fi

pip install -r requirements/dev.txt

cat > config.json << EOF
{
    "DATABASE": {
        "NAME": "biohub_new",
        "USER": "root",
        "PASSWORD": "",
        "HOST": "localhost",
        "PORT": "",
        "TEST": {
            "NAME": "test_biohub_new",
            "CHARSET": "utf8",
            "COLLATION": "utf8_general_ci",
            "MIRROR": null
        }
    },
    "PLUGINS": [],
    "TIMEZONE": "UTC",
    "UPLOAD_DIR": "/tmp/biohub",
    "REDIS_URI": "redis://localhost:6379"
}
EOF

if [ ! -f tmp/biobricks.sql ]; then
    mkdir tmp
    wget http://parts.igem.org/partsdb/download.cgi?type=parts_sql -O tmp/biobricks.sql.gz
    gunzip tmp/biobricks.sql.gz
fi

mysql -uroot -e 'CREATE DATABASE IF NOT EXISTS biohub_new;'
biohub/manage.py migrate
mysql -uroot biohub_new < tmp/biobricks.sql
biohub/manage.py update_index
