#!/bin/bash

wget https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.6.deb -O es.deb
sudo dpkg -i --force-confnew es.deb
sudo service elasticsearch start

python3.4 biohub/biocircuit/compile-espresso.py

python -c "import os;os.chdir('biohub/biocircuit');from espresso import espresso"

if [ $? -ne 0 ]; then
    exit 1
fi

pip install -r requirements/dev.txt
pip install -r requirements/abacus-server.txt

cat > config.json << EOF
{
    "DATABASE": {
        "NAME": "biohub_new",
        "USER": "root",
        "PASSWORD": "",
        "HOST": "localhost",
        "PORT": "",
        "TEST": {
            "NAME": "test_biohub_new",
            "CHARSET": "utf8",
            "COLLATION": "utf8_general_ci",
            "MIRROR": null
        }
    },
    "PLUGINS": ["biohub.abacus"],
    "TIMEZONE": "UTC",
    "UPLOAD_DIR": "/tmp/biohub",
    "REDIS_URI": "redis://localhost:6379"
}
EOF

if [ ! -f tmp/biobricks.sql ]; then
    mkdir tmp
    wget http://parts.igem.org/partsdb/download.cgi?type=parts_sql -O tmp/biobricks.sql.gz
    gunzip tmp/biobricks.sql.gz
fi

mysql -uroot -e 'CREATE DATABASE IF NOT EXISTS biohub_new;'
biohub/manage.py migrate
mysql -uroot biohub_new < tmp/biobricks.sql
biohub/manage.py update_index

cat > biohub/abacus/config.json << EOF2
{
    "ABACUS_JAR_PATH": "$PWD/tests/abacus/FakeAbacus/bin/FakeAbacus.jar",
    "ABACUS_DATABASE_PATH": "$PWD/config.json",
    "ABACUS_REMOTE_SERVER": "http://localhost:46135/"
}
EOF2

cat > abacus_server/config.json << EOF3
{
    "ABACUS_JAR_PATH": "$PWD/tests/abacus/FakeAbacus/bin/FakeAbacus.jar",
    "REDIS_URI": "redis://localhost:6379",
    "ABACUS_DATABASE_PATH": "$PWD/config.json",
    "STORAGE_ROOT": "/tmp/abacus_server/"
}
EOF3

nohup python -m abacus_server --port 46135 &
sleep 3
cat nohup.out

# For testing
mysql -uroot -e 'CREATE DATABASE IF NOT EXISTS test_biohub_new;'
mysql -uroot test_biohub_new < tmp/biobricks.sql
